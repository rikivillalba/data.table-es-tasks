<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />


<meta name="date" content="2024-09-21" />

<title>Introduction to data.table</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introduction to data.table</h1>
<h4 class="date">2024-09-21</h4>



<p>Esta viñeta introduce la sintaxis de <code>data.table</code>, su
forma general, cómo crear <em>subconjuntos</em> de filas,
<em>seleccionar y calcular</em> columnas y realizar agregaciones <em>por
grupo</em>. Es útil estar familiarizado con la estructura de datos
<code>data.frame</code> de R básico, pero no es esencial para seguir
esta viñeta.</p>
<hr />
<div id="análisis-de-datos-utilizando-data.table" class="section level2">
<h2>Análisis de datos utilizando <code>data.table</code></h2>
<p>Las operaciones de manipulación de datos como <em>subconjunto</em>,
<em>grupo</em>, <em>actualización</em>, <em>unión</em>, etc. están todas
relacionadas de manera inherente. Mantener juntas estas <em>operaciones
relacionadas</em> permite:</p>
<p>=====* Sintaxis <em>concisa</em> y <em>consistente</em>
independientemente del conjunto de operaciones que desee realizar para
lograr su objetivo final.=====</p>
<p>=====* realizar análisis <em>de manera fluida</em> sin la carga
cognitiva de tener que asignar cada operación a una función particular
de un conjunto potencialmente enorme de funciones disponibles antes de
realizar el análisis.=====</p>
<p>=====* optimizar <em>automáticamente</em> las operaciones
internamente y de manera muy efectiva al conocer con precisión los datos
necesarios para cada operación, lo que genera un código muy rápido y con
uso eficiente de la memoria.=====</p>
<p>En resumen, si está interesado en reducir enormemente el tiempo de
<em>programación</em> y <em>computación</em>, este paquete es para
usted. La filosofía a la que adhiere <code>data.table</code> lo hace
posible. Nuestro objetivo es ilustrarlo a través de esta serie de
viñetas.</p>
</div>
<div id="data" class="section level2">
<h2>Datos</h2>
<p>En esta viñeta, utilizaremos los datos de <a href="https://raw.githubusercontent.com/Rdatatable/data.table/master/vignettes/flights14.csv">NYC-flights14</a>
obtenidos del paquete <a href="https://github.com/arunsrinivasan/flights">flights</a> (disponible
solo en GitHub). Contiene datos de vuelos puntuales de la Oficina de
Estadísticas de Transporte para todos los vuelos que partieron de los
aeropuertos de la ciudad de Nueva York en 2014 (inspirados en <a href="https://github.com/tidyverse/nycflights13">nycflights13</a>). Los
datos están disponibles solo para enero-octubre de 2014.</p>
<p>Podemos usar el lector de archivos rápido y amigable
<code>fread</code> de <code>data.table</code> para cargar
<code>flights</code> directamente de la siguiente manera:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>input <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">file.exists</span>(<span class="st">&quot;flights14.csv&quot;</span>)) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>   <span class="st">&quot;flights14.csv&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="st">&quot;https://raw.githubusercontent.com/Rdatatable/data.table/master/vignettes/flights14.csv&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>}</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>flights <span class="ot">&lt;-</span> <span class="fu">fread</span>(input)</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>flights</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co">#          year month   day dep_delay arr_delay carrier origin   dest air_time distance  hour</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="co">#         &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;     &lt;int&gt;  &lt;char&gt; &lt;char&gt; &lt;char&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="co">#      1:  2014     1     1        14        13      AA    JFK    LAX      359     2475     9</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co">#      2:  2014     1     1        -3        13      AA    JFK    LAX      363     2475    11</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="co">#      3:  2014     1     1         2         9      AA    JFK    LAX      351     2475    19</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="co">#      4:  2014     1     1        -8       -26      AA    LGA    PBI      157     1035     7</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="co">#      5:  2014     1     1         2         1      AA    JFK    LAX      350     2475    13</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co">#     ---                                                                                    </span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="co"># 253312:  2014    10    31         1       -30      UA    LGA    IAH      201     1416    14</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="co"># 253313:  2014    10    31        -5       -14      UA    EWR    IAH      189     1400     8</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="co"># 253314:  2014    10    31        -8        16      MQ    LGA    RDU       83      431    11</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a><span class="co"># 253315:  2014    10    31        -4        15      MQ    LGA    DTW       75      502    11</span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a><span class="co"># 253316:  2014    10    31        -5         1      MQ    LGA    SDF      110      659     8</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="fu">dim</span>(flights)</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="co"># [1] 253316     11</span></span></code></pre></div>
<p>Nota: <code>fread</code> acepta URL <code>http</code> y
<code>https</code> directamente, así como comandos del sistema operativo
como <code>sed</code> y <code>awk</code>. Consulta <code>?fread</code>
para ver ejemplos.</p>
</div>
<div id="introducción" class="section level2">
<h2>Introducción</h2>
<p>En esta viñeta, vamos a</p>
<p>=====1. Comience con lo básico: qué es una <code>data.table</code>,
su forma general, cómo crear <em>subconjuntos</em> de filas, cómo
<em>seleccionar y calcular</em> columnas;=====</p>
<ol start="2" style="list-style-type: decimal">
<li>Luego veremos cómo realizar agregaciones de datos por grupo</li>
</ol>
</div>
<div id="basics-1" class="section level2">
<h2>1. Conceptos básicos</h2>
<div id="what-is-datatable-1a" class="section level3">
<h3>a) ¿Qué es <code>data.table</code>?</h3>
<p><code>data.table</code> es un paquete R que proporciona <strong>una
versión mejorada</strong> de un <code>data.frame</code>, la estructura
de datos estándar para almacenar datos en <code>base</code> R. En la
sección <a href="#data">Data</a> anterior, vimos cómo crear un
<code>data.table</code> usando <code>fread()</code>, pero también
podemos crear uno usando la función <code>data.table()</code>. Aquí hay
un ejemplo:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>DT <span class="ot">=</span> <span class="fu">data.table</span>(</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="at">ID =</span> <span class="fu">c</span>(<span class="st">&quot;b&quot;</span>,<span class="st">&quot;b&quot;</span>,<span class="st">&quot;b&quot;</span>,<span class="st">&quot;a&quot;</span>,<span class="st">&quot;a&quot;</span>,<span class="st">&quot;c&quot;</span>),</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="at">a =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="at">b =</span> <span class="dv">7</span><span class="sc">:</span><span class="dv">12</span>,</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  <span class="at">c =</span> <span class="dv">13</span><span class="sc">:</span><span class="dv">18</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>DT</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">#        ID     a     b     c</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co">#    &lt;char&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co"># 1:      b     1     7    13</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="co"># 2:      b     2     8    14</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="co"># 3:      b     3     9    15</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co"># 4:      a     4    10    16</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="co"># 5:      a     5    11    17</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a><span class="co"># 6:      c     6    12    18</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="fu">class</span>(DT<span class="sc">$</span>ID)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a><span class="co"># [1] &quot;character&quot;</span></span></code></pre></div>
<p>También puede convertir objetos existentes en una tabla
<code>data.table</code> utilizando <code>setDT()</code> (para
estructuras <code>data.frame</code> y <code>list</code>) o
<code>as.data.table()</code> (para otras estructuras). Para obtener más
detalles sobre la diferencia (que va más allá del alcance de esta
viñeta), consulte <code>?setDT</code> y <code>?as.data.table</code>.</p>
<div id="tenga-en-cuenta-que" class="section level4">
<h4>Tenga en cuenta que:</h4>
<p>=====* Los números de fila se imprimen con un <code>:</code> para
separar visualmente el número de fila de la primera columna.=====</p>
<p>=====* Cuando el número de filas a imprimir excede la opción global
<code>datatable.print.nrows</code> (predeterminado =
<code>r getOption(&quot;datatable.print.nrows&quot;)</code>), imprime
automáticamente solo las primeras 5 y las últimas 5 filas (como se puede
ver en la sección <a href="#data">Data</a>). Para un
<code>data.frame</code> grande, es posible que se haya encontrado
esperando mientras se imprimen y paginan tablas más grandes, a veces
aparentemente sin fin. Esta restricción ayuda con eso, y puede consultar
el número predeterminado de la siguiente manera:=====</p>
<pre><code>```{.r}
getOption(&quot;datatable.print.nrows&quot;)
```</code></pre>
<p>=====* <code>data.table</code> nunca establece ni utiliza <em>nombres
de fila</em>. Veremos por qué en la viñeta <em>“Subconjunto basado en
claves y búsqueda binaria rápida”</em>.=====</p>
</div>
</div>
<div id="enhanced-1b" class="section level3">
<h3>b) Forma general: ¿de qué manera se <em>mejora</em> una tabla
<code>data.table</code>?</h3>
<p>A diferencia de un <code>data.frame</code>, puede hacer <em>mucho
más</em> que simplemente crear subconjuntos de filas y seleccionar
columnas dentro del marco de un <code>data.table</code>, es decir,
dentro de <code>[...]</code> (NB: también podríamos referirnos a
escribir cosas dentro de <code>DT[...]</code> como “consultar
<code>DT</code>”, como una analogía o en relación con SQL). Para
entenderlo, primero tendremos que mirar la <em>forma general</em> de la
sintaxis de <code>data.table</code>, como se muestra a continuación:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>DT[i, j, by]</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="do">##   R:                 i                 j        by</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="do">## SQL:  where | order by   select | update  group by</span></span></code></pre></div>
<p>Los usuarios con conocimientos de SQL quizás se sientan
inmediatamente identificados con esta sintaxis.</p>
<div id="la-forma-de-leerlo-en-voz-alta-es" class="section level4">
<h4>La forma de leerlo (en voz alta) es:</h4>
<p>Tome <code>DT</code>, subconjunto/reordene filas usando
<code>i</code>, luego calcule <code>j</code>, agrupado por
<code>by</code>.</p>
<p>Comencemos mirando primero <code>i</code> y <code>j</code>:
subconjuntando filas y operando en columnas.</p>
</div>
</div>
<div id="subset-i-1c" class="section level3">
<h3>c) Subconjunto de filas en <code>i</code></h3>
<div id="obtenga-todos-los-vuelos-con-jfk-como-aeropuerto-de-origen-en-el-mes-de-junio." class="section level4">
<h4>– Obtenga todos los vuelos con “JFK” como aeropuerto de origen en el
mes de junio.</h4>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[origin <span class="sc">==</span> <span class="st">&quot;JFK&quot;</span> <span class="sc">&amp;</span> month <span class="sc">==</span> <span class="dv">6</span><span class="dt">L</span>]</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">#     year month   day dep_delay arr_delay carrier origin   dest air_time distance  hour</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">#    &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;     &lt;int&gt;  &lt;char&gt; &lt;char&gt; &lt;char&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="co"># 1:  2014     6     1        -9        -5      AA    JFK    LAX      324     2475     8</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co"># 2:  2014     6     1       -10       -13      AA    JFK    LAX      329     2475    12</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co"># 3:  2014     6     1        18        -1      AA    JFK    LAX      326     2475     7</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="co"># 4:  2014     6     1        -6       -16      AA    JFK    LAX      320     2475    10</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co"># 5:  2014     6     1        -4       -45      AA    JFK    LAX      326     2475    18</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="co"># 6:  2014     6     1        -6       -23      AA    JFK    LAX      329     2475    14</span></span></code></pre></div>
<p>=====* Dentro del marco de una <code>data.table</code>, se puede
hacer referencia a las columnas <em>como si fueran variables</em>, de
forma muy similar a SQL o Stata. Por lo tanto, simplemente nos referimos
a <code>origin</code> y <code>month</code> como si fueran variables. No
necesitamos agregar el prefijo <code>flights$$$</code> cada vez. Sin
embargo, usar <code>flights$$$origin</code> y
<code>flights$$$month</code> funcionaría perfectamente.=====</p>
<p>=====* Se calculan los <em>índices de fila</em> que satisfacen la
condición <code>origin == &quot;JFK&quot; &amp; month == 6L</code> y, dado que no
hay nada más que hacer, todas las columnas de <code>flights</code> en
las filas correspondientes a esos <em>índices de fila</em> simplemente
se devuelven como una <code>data.table</code>.=====</p>
<p>=====* Aunque no es necesario incluir una coma después de la
condición en <code>i</code>,
<code>flights[origin == &quot;JFK&quot; &amp; month == 6L, ]</code> funcionará
perfectamente. Sin embargo, en un <code>data.frame</code>, la coma es
necesaria.=====</p>
</div>
<div id="subset-rows-integer" class="section level4">
<h4>– Obtener las dos primeras filas de <code>vuelos</code>.</h4>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>]</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>ans</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">#     year month   day dep_delay arr_delay carrier origin   dest air_time distance  hour</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">#    &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;     &lt;int&gt;  &lt;char&gt; &lt;char&gt; &lt;char&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co"># 1:  2014     1     1        14        13      AA    JFK    LAX      359     2475     9</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co"># 2:  2014     1     1        -3        13      AA    JFK    LAX      363     2475    11</span></span></code></pre></div>
<p>=====* En este caso, no hay ninguna condición. Los índices de fila ya
se proporcionan en <code>i</code>. Por lo tanto, devolvemos una
<code>data.table</code> con todas las columnas de <code>flights</code>
en las filas para esos <em>índices de fila</em>.=====</p>
</div>
<div id="ordena-vuelos-primero-por-la-columna-origen-en-orden-ascendente-y-luego-por-destino-en-orden-descendente" class="section level4">
<h4>– Ordena <code>vuelos</code> primero por la columna
<code>origen</code> en orden <em>ascendente</em>, y luego por
<code>destino</code> en orden <em>descendente</em>:</h4>
<p>Podemos utilizar la función R <code>order()</code> para lograr
esto.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[<span class="fu">order</span>(origin, <span class="sc">-</span>dest)]</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#     year month   day dep_delay arr_delay carrier origin   dest air_time distance  hour</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#    &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;     &lt;int&gt;  &lt;char&gt; &lt;char&gt; &lt;char&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co"># 1:  2014     1     5         6        49      EV    EWR    XNA      195     1131     8</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="co"># 2:  2014     1     6         7        13      EV    EWR    XNA      190     1131     8</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co"># 3:  2014     1     7        -6       -13      EV    EWR    XNA      179     1131     8</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co"># 4:  2014     1     8        -7       -12      EV    EWR    XNA      184     1131     8</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co"># 5:  2014     1     9        16         7      EV    EWR    XNA      181     1131     8</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co"># 6:  2014     1    13        66        66      EV    EWR    XNA      188     1131     9</span></span></code></pre></div>
</div>
<div id="order-está-optimizado-internamente" class="section level4">
<h4><code>order()</code> está optimizado internamente</h4>
<p>=====* Podemos usar “-” en columnas de <code>caracteres</code> dentro
del marco de una <code>tabla de datos</code> para ordenar en orden
decreciente.=====</p>
<p>=====* Además, <code>order(...)</code> dentro del marco de una
<code>data.table</code> utiliza el ordenamiento rápido interno de
<code>data.table</code> <code>forder()</code>. Esta clasificación
proporcionó una mejora tan convincente con respecto a
<code>base::order</code> de R que el proyecto R adoptó el algoritmo
<code>data.table</code> como su clasificación predeterminada en 2016
para R 3.3.0 (para referencia, consulte <code>?sort</code> y <a href="https://cran.r-project.org/doc/manuals/r-release/NEWS.pdf">R
Release NEWS</a>).=====</p>
<p>Discutiremos el orden rápido de <code>data.table</code> con más
detalle en la viñeta <em>Aspectos internos de
<code>data.table</code></em>.</p>
</div>
</div>
<div id="select-j-1d" class="section level3">
<h3>d) Seleccione la(s) columna(s) en <code>j</code></h3>
<div id="selecciona-la-columna-arr_delay-pero-devuélvela-como-un-vector." class="section level4">
<h4>– Selecciona la columna <code>arr_delay</code>, pero devuélvela como
un <em>vector</em>.</h4>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[, arr_delay]</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># [1]  13  13   9 -26   1   0</span></span></code></pre></div>
<p>=====* Dado que se puede hacer referencia a las columnas como si
fueran variables dentro del marco de una <code>data.table</code>,
hacemos referencia directamente a la <em>variable</em> que queremos
subconjunto. Como queremos <em>todas las filas</em>, simplemente
omitimos <code>i</code>.=====</p>
<ul>
<li>Devuelve <em>todas</em> las filas de la columna
<code>arr_delay</code>.</li>
</ul>
</div>
<div id="seleccione-la-columna-arr_delay-pero-devuélvala-como-data.table-en-su-lugar." class="section level4">
<h4>– Seleccione la columna <code>arr_delay</code>, pero devuélvala como
<code>data.table</code> en su lugar.</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[, <span class="fu">list</span>(arr_delay)]</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">#    arr_delay</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">#        &lt;int&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co"># 1:        13</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="co"># 2:        13</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="co"># 3:         9</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a><span class="co"># 4:       -26</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="co"># 5:         1</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a><span class="co"># 6:         0</span></span></code></pre></div>
<p>=====* Envolvemos las <em>variables</em> (nombres de columnas) dentro
de <code>list()</code>, lo que garantiza que se devuelva una
<code>data.table</code>. En el caso de un solo nombre de columna, no
envolver con <code>list()</code> devuelve un vector en su lugar, como se
ve en el <a href="#select-j-1d">ejemplo anterior</a>.=====</p>
<p>=====* <code>data.table</code> también permite envolver columnas con
<code>.()</code> en lugar de <code>list()</code>. Es decir,
<code>.()</code> es un <em>alias</em> de <code>list()</code>; ambos
significan lo mismo. Siéntase libre de usar el que prefiera; hemos
notado que la mayoría de los usuarios prefieren <code>.()</code> por ser
más conciso, por lo que continuaremos usando <code>.()</code> de aquí en
adelante.=====</p>
<p>Una tabla <code>data.table</code> (y también un
<code>data.frame</code>) es internamente un <code>list</code> también,
con la condición de que cada elemento tiene la misma longitud y la
<code>list</code> tiene un atributo <code>class</code>. Al permitir que
<code>j</code> devuelva un <code>list</code> es posible convertir y
devolver una <code>data.table</code> de manera muy eficiente.</p>
</div>
<div id="tip-1" class="section level4">
<h4>Consejo:</h4>
<p>Mientras la expresión <code>j</code> devuelva un <code>list</code>,
cada elemento de la lista se convertirá en una columna en la
<code>data.table</code> resultante. Esto hace que <code>j</code> sea
bastante potente, como veremos en breve. ¡También es muy importante
comprender esto para cuando desee realizar consultas más
complicadas!</p>
</div>
<div id="seleccione-las-columnas-arr_delay-y-dep_delay." class="section level4">
<h4>– Seleccione las columnas <code>arr_delay</code> y
<code>dep_delay</code>.</h4>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[, .(arr_delay, dep_delay)]</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co">#    arr_delay dep_delay</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">#        &lt;int&gt;     &lt;int&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co"># 1:        13        14</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="co"># 2:        13        -3</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="co"># 3:         9         2</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a><span class="co"># 4:       -26        -8</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="co"># 5:         1         2</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="co"># 6:         0         4</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="do">## alternatively</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co"># ans &lt;- flights[, list(arr_delay, dep_delay)]</span></span></code></pre></div>
<ul>
<li>Envuelve ambas columnas dentro de <code>.()</code> o
<code>list()</code>. Eso es todo.</li>
</ul>
</div>
<div id="seleccione-las-columnas-arr_delay-y-dep_delay-y-cámbieles-el-nombre-a-delay_arr-y-delay_dep." class="section level4">
<h4>– Seleccione las columnas <code>arr_delay</code> y
<code>dep_delay</code> <em>y</em> cámbieles el nombre a
<code>delay_arr</code> y <code>delay_dep</code>.</h4>
<p>Dado que <code>.()</code> es solo un alias de <code>list()</code>,
podemos nombrar las columnas como lo haríamos al crear una
<code>list</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[, .(<span class="at">delay_arr =</span> arr_delay, <span class="at">delay_dep =</span> dep_delay)]</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">#    delay_arr delay_dep</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co">#        &lt;int&gt;     &lt;int&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co"># 1:        13        14</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co"># 2:        13        -3</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co"># 3:         9         2</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co"># 4:       -26        -8</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co"># 5:         1         2</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co"># 6:         0         4</span></span></code></pre></div>
</div>
</div>
<div id="e-calcular-o-ejecutar-en-j" class="section level3">
<h3>e) Calcular o <em>ejecutar</em> en <code>j</code></h3>
<div id="cuántos-viajes-han-tenido-un-retraso-total-0" class="section level4">
<h4>–¿Cuántos viajes han tenido un retraso total &lt; 0?</h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[, <span class="fu">sum</span>( (arr_delay <span class="sc">+</span> dep_delay) <span class="sc">&lt;</span> <span class="dv">0</span> )]</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>ans</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co"># [1] 141814</span></span></code></pre></div>
</div>
<div id="que-está-pasando-aquí" class="section level4">
<h4>¿Que está pasando aquí?</h4>
<p>=====* La función <code>j</code> de <code>data.table</code> puede
manejar más que simplemente <em>seleccionar columnas</em> - puede
manejar <em>expresiones</em>, es decir, <em>hacer cálculos sobre
columnas</em>. Esto no debería sorprender, ya que se puede hacer
referencia a las columnas como si fueran variables. Entonces deberíamos
poder <em>hacer cálculos</em> llamando a funciones sobre esas variables.
Y eso es precisamente lo que sucede aquí.=====</p>
</div>
</div>
<div id="f-subconjunto-en-i-y-hacer-en-j" class="section level3">
<h3>f) Subconjunto en <code>i</code> <em>y</em> hacer en
<code>j</code></h3>
<div id="calcular-el-retraso-medio-de-llegada-y-salida-para-todos-los-vuelos-con-aeropuerto-de-origen-jfk-en-el-mes-de-junio." class="section level4">
<h4>– Calcular el retraso medio de llegada y salida para todos los
vuelos con aeropuerto de origen “JFK” en el mes de junio.</h4>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[origin <span class="sc">==</span> <span class="st">&quot;JFK&quot;</span> <span class="sc">&amp;</span> month <span class="sc">==</span> <span class="dv">6</span><span class="dt">L</span>,</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>               .(<span class="at">m_arr =</span> <span class="fu">mean</span>(arr_delay), <span class="at">m_dep =</span> <span class="fu">mean</span>(dep_delay))]</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>ans</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co">#       m_arr    m_dep</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="co">#       &lt;num&gt;    &lt;num&gt;</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co"># 1: 5.839349 9.807884</span></span></code></pre></div>
<p>=====* Primero creamos un subconjunto en <code>i</code> para
encontrar los <em>índices de fila</em> coincidentes donde
<code>origin</code> aeropuerto es igual a <code>&quot;JFK&quot;</code>, y
<code>month</code> es igual a <code>6L</code>. <em>Todavía</em> no
creamos un subconjunto de la <code>data.table</code> <em>completa</em>
correspondiente a esas filas.=====</p>
<p>=====* Ahora, observamos <code>j</code> y descubrimos que utiliza
solo <em>dos columnas</em>. Y lo que tenemos que hacer es calcular su
<code>mean()</code>. Por lo tanto, creamos un subconjunto de las
columnas que corresponden a las filas coincidentes y calculamos su
<code>mean()</code>.=====</p>
<p>Debido a que los tres componentes principales de la consulta
(<code>i</code>, <code>j</code> y <code>by</code>) están <em>juntos</em>
dentro de <code>[...]</code>, <code>data.table</code> puede ver los tres
y optimizar la consulta en conjunto <em>antes de la evaluación</em>, en
lugar de optimizar cada uno por separado. Por lo tanto, podemos evitar
todo el subconjunto (es decir, crear subconjuntos de las columnas
<em>además de</em> <code>arr_delay</code> y <code>dep_delay</code>),
tanto por velocidad como por eficiencia de memoria.</p>
</div>
<div id="cuántos-viajes-se-han-realizado-en-el-año-2014-desde-el-aeropuerto-jfk-en-el-mes-de-junio" class="section level4">
<h4>–¿Cuántos viajes se han realizado en el año 2014 desde el aeropuerto
“JFK” en el mes de junio?</h4>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[origin <span class="sc">==</span> <span class="st">&quot;JFK&quot;</span> <span class="sc">&amp;</span> month <span class="sc">==</span> <span class="dv">6</span><span class="dt">L</span>, <span class="fu">length</span>(dest)]</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>ans</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="co"># [1] 8422</span></span></code></pre></div>
<p>La función length() requiere un argumento de entrada. Solo
necesitamos calcular la cantidad de filas en el subconjunto. Podríamos
haber usado cualquier otra columna como argumento de entrada para
length(). Este enfoque recuerda a SELECT COUNT(dest) FROM flights WHERE
origin = ‘JFK’ AND month = 6 en SQL.</p>
<p>Este tipo de operación ocurre con bastante frecuencia, especialmente
durante la agrupación (como veremos en la siguiente sección), hasta el
punto donde <code>data.table</code> proporciona un <em>símbolo
especial</em> <code>.N</code> para ello.</p>
</div>
</div>
<div id="g-manejo-de-elementos-inexistentes-en-i" class="section level3">
<h3>g) Manejo de elementos inexistentes en <code>i</code></h3>
<div id="qué-sucede-cuando-se-consultan-elementos-no-existentes" class="section level4">
<h4>–¿Qué sucede cuando se consultan elementos no existentes?</h4>
<p>Al consultar una <code>data.table</code> en busca de elementos que no
existen, el comportamiento difiere según el método utilizado.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">setkeyv</span>(flights, <span class="st">&quot;origin&quot;</span>)</span></code></pre></div>
<ul>
<li><strong>Subconjunto basado en clave:
<code>dt[&quot;d&quot;]</code></strong></li>
</ul>
<p>Esto realiza una unión a la derecha en la columna de clave
<code>x</code>, lo que da como resultado una fila con <code>d</code> y
<code>NA</code> para las columnas que no se encuentran. Al utilizar
<code>setkeyv</code>, la tabla se ordena por las claves especificadas y
se crea un índice interno, lo que permite la búsqueda binaria para una
subdivisión eficiente.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>flights[<span class="st">&quot;XYZ&quot;</span>]</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co"># Returns:</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">#    origin year month day dep_time sched_dep_time dep_delay arr_time sched_arr_time arr_delay carrier flight tailnum ...</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co"># 1:    XYZ   NA    NA  NA       NA             NA        NA       NA             NA        NA      NA     NA      NA ...</span></span></code></pre></div>
<ul>
<li><strong>Subconjunto lógico: <code>dt[x == &quot;d&quot;]</code></strong></li>
</ul>
<p>Esto realiza una operación de subconjunto estándar que no encuentra
ninguna fila coincidente y, por lo tanto, devuelve una
<code>data.table</code> vacía.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>  flights[origin <span class="sc">==</span> <span class="st">&quot;XYZ&quot;</span>]</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co"># Returns:</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="co"># Empty data.table (0 rows and 19 cols): year,month,day,dep_time,sched_dep_time,dep_delay,arr_time,sched_arr_time,arr_delay,...</span></span></code></pre></div>
<ul>
<li><strong>Coincidencia exacta usando
<code>nomatch=NULL</code></strong></li>
</ul>
<p>Para coincidencias exactas sin <code>NA</code> para elementos
inexistentes, utilice <code>nomatch=NULL</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>flights[<span class="st">&quot;XYZ&quot;</span>, nomatch<span class="ot">=</span><span class="cn">NULL</span>]</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co"># Returns:</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="co"># Empty data.table (0 rows and 19 cols): year,month,day,dep_time,sched_dep_time,dep_delay,arr_time,sched_arr_time,arr_delay,...</span></span></code></pre></div>
<p>Comprender estos comportamientos puede ayudar a evitar confusiones al
tratar con elementos inexistentes en sus datos.</p>
</div>
<div id="special-N" class="section level4">
<h4>Símbolo especial <code>.N</code>:</h4>
<p><code>.N</code> es una variable incorporada especial que contiene la
cantidad de observaciones <em>en el grupo actual</em>. Es
particularmente útil cuando se combina con <code>by</code> como veremos
en la siguiente sección. En ausencia de operaciones de agrupamiento por,
simplemente devuelve la cantidad de filas en el subconjunto.</p>
<p>Ahora que lo sabemos, podemos realizar la misma tarea utilizando
<code>.N</code> de la siguiente manera:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[origin <span class="sc">==</span> <span class="st">&quot;JFK&quot;</span> <span class="sc">&amp;</span> month <span class="sc">==</span> <span class="dv">6</span><span class="dt">L</span>, .N]</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>ans</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="co"># [1] 8422</span></span></code></pre></div>
<p>=====* Una vez más, subconjunto en <code>i</code> para obtener los
<em>índices de fila</em> donde el aeropuerto <code>origen</code> es
igual a <em>“JFK”</em>, y el mes es igual a <em>6</em>.=====</p>
<p>=====* Vemos que <code>j</code> utiliza solo <code>.N</code> y
ninguna otra columna. Por lo tanto, no se materializa el subconjunto
completo. Simplemente devolvemos la cantidad de filas en el subconjunto
(que es solo la longitud de los índices de fila).=====</p>
<p>=====* Tenga en cuenta que no hemos incluido <code>.N</code> en
<code>list()</code> o <code>.()</code>. Por lo tanto, se devuelve un
vector.=====</p>
<p>Podríamos haber realizado la misma operación haciendo
<code>nrow(flights[origin == &quot;JFK&quot; &amp; month == 6L])</code>. Sin
embargo, tendríamos que crear primero un subconjunto de toda la
<code>data.table</code> correspondiente a los <em>índices de fila</em>
en <code>i</code> <em>y luego</em> devolver las filas usando
<code>nrow()</code>, lo cual es innecesario e ineficiente. Trataremos
este y otros aspectos de optimización en detalle en la viñeta de
<em>diseño de <code>data.table</code></em>.</p>
</div>
</div>
<div id="refer_j" class="section level3">
<h3>h) ¡Genial! Pero, ¿cómo puedo hacer referencia a las columnas por
nombres en <code>j</code> (como en un <code>data.frame</code>)?</h3>
<p>Si escribe los nombres de las columnas explícitamente, no hay
diferencia en comparación con un <code>data.frame</code> (desde
v1.9.8).</p>
<div id="seleccione-las-columnas-arr_delay-y-dep_delay-mediante-el-método-data.frame." class="section level4">
<h4>– Seleccione las columnas <code>arr_delay</code> y
<code>dep_delay</code> mediante el método <code>data.frame</code>.</h4>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[, <span class="fu">c</span>(<span class="st">&quot;arr_delay&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>)]</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="co">#    arr_delay dep_delay</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="co">#        &lt;int&gt;     &lt;int&gt;</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="co"># 1:        13        14</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="co"># 2:        13        -3</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="co"># 3:         9         2</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="co"># 4:       -26        -8</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a><span class="co"># 5:         1         2</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="co"># 6:         0         4</span></span></code></pre></div>
<p>Si ha almacenado las columnas deseadas en un vector de caracteres,
hay dos opciones: utilizar el prefijo <code>..</code> o utilizar el
argumento <code>with</code>.</p>
</div>
<div id="seleccionar-columnas-nombradas-en-una-variable-usando-el-prefijo-.." class="section level4">
<h4>– Seleccionar columnas nombradas en una variable usando el prefijo
<code>..</code></h4>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>select_cols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;arr_delay&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>flights[ , ..select_cols]</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="co">#         arr_delay dep_delay</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="co">#             &lt;int&gt;     &lt;int&gt;</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="co">#      1:        13        14</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="co">#      2:        13        -3</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a><span class="co">#      3:         9         2</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="co">#      4:       -26        -8</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="co">#      5:         1         2</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a><span class="co">#     ---                    </span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="co"># 253312:       -30         1</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a><span class="co"># 253313:       -14        -5</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a><span class="co"># 253314:        16        -8</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a><span class="co"># 253315:        15        -4</span></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="co"># 253316:         1        -5</span></span></code></pre></div>
<p>Para aquellos familiarizados con la terminal Unix, el prefijo
<code>..</code> debería recordar al comando “subir-un-nivel”, que es
análogo a lo que sucede aquí: <code>..</code> indica a
<code>data.table</code> que busque la variable <code>select_cols</code>
“up-one-level”, es decir, dentro del entorno global en este caso.</p>
</div>
<div id="seleccionar-columnas-nombradas-en-una-variable-usando-with-false" class="section level4">
<h4>– Seleccionar columnas nombradas en una variable usando
<code>with = FALSE</code></h4>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>flights[ , select_cols, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="co">#         arr_delay dep_delay</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="co">#             &lt;int&gt;     &lt;int&gt;</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co">#      1:        13        14</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="co">#      2:        13        -3</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="co">#      3:         9         2</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="co">#      4:       -26        -8</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="co">#      5:         1         2</span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="co">#     ---                    </span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="co"># 253312:       -30         1</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="co"># 253313:       -14        -5</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="co"># 253314:        16        -8</span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a><span class="co"># 253315:        15        -4</span></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a><span class="co"># 253316:         1        -5</span></span></code></pre></div>
<p>El argumento se llama <code>with</code> en honor a la función R
<code>with()</code> debido a que tiene una funcionalidad similar.
Supongamos que tiene un <code>data.frame</code> <code>DF</code> y desea
crear un subconjunto de todas las filas donde <code>x &gt; 1</code>. En
<code>base</code> R puede hacer lo siguiente:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>DF <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>,<span class="dv">3</span>), <span class="at">y =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="do">## (1) normal way</span></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>DF[DF<span class="sc">$</span>x <span class="sc">&gt;</span> <span class="dv">1</span>, ] <span class="co"># data.frame needs that &#39;,&#39; as well</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="co">#   x y</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="co"># 4 2 4</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a><span class="co"># 5 2 5</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a><span class="co"># 6 3 6</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a><span class="co"># 7 3 7</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a><span class="co"># 8 3 8</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a><span class="do">## (2) using with</span></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>DF[<span class="fu">with</span>(DF, x <span class="sc">&gt;</span> <span class="dv">1</span>), ]</span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a><span class="co">#   x y</span></span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a><span class="co"># 4 2 4</span></span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a><span class="co"># 5 2 5</span></span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a><span class="co"># 6 3 6</span></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a><span class="co"># 7 3 7</span></span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a><span class="co"># 8 3 8</span></span></code></pre></div>
<p>=====* El uso de <code>with()</code> en (2) permite usar la columna
<code>x</code> de <code>DF</code> como si fuera una variable.=====</p>
<pre><code>Hence, the argument name `with` in `data.table`. Setting `with = FALSE` disables the ability to refer to columns as if they are variables, thereby restoring the &quot;`data.frame` mode&quot;.</code></pre>
<p>=====* También podemos <em>deseleccionar</em> columnas usando
<code>-</code> o <code>!</code>. Por ejemplo:=====</p>
<pre><code>``` r
## not run

# returns all columns except arr_delay and dep_delay
ans &lt;- flights[, !c(&quot;arr_delay&quot;, &quot;dep_delay&quot;)]
# or
ans &lt;- flights[, -c(&quot;arr_delay&quot;, &quot;dep_delay&quot;)]
```</code></pre>
<p>=====* Desde <code>v1.9.5+</code>, también podemos seleccionar
especificando los nombres de las columnas de inicio y fin, por ejemplo,
<code>año:día</code> para seleccionar las primeras tres
columnas.=====</p>
<pre><code>``` r
## not run

# returns year,month and day
ans &lt;- flights[, year:day]
# returns day, month and year
ans &lt;- flights[, day:year]
# returns all columns except year, month and day
ans &lt;- flights[, -(year:day)]
ans &lt;- flights[, !(year:day)]
```

This is particularly handy while working interactively.</code></pre>
<p><code>with = TRUE</code> es el valor predeterminado en
<code>data.table</code> porque podemos hacer mucho más al permitir que
<code>j</code> maneje expresiones, especialmente cuando se combina con
<code>by</code>, como veremos en un momento.</p>
</div>
</div>
</div>
<div id="agregaciones" class="section level2">
<h2>2. Agregaciones</h2>
<p>Ya hemos visto <code>i</code> y <code>j</code> de la forma general de
<code>data.table</code> en la sección anterior. En esta sección, veremos
cómo se pueden combinar con <code>by</code> para realizar operaciones
<em>por grupo</em>. Veamos algunos ejemplos.</p>
<div id="a-agrupación-mediante-by" class="section level3">
<h3>a) Agrupación mediante <code>by</code></h3>
<div id="cómo-podemos-obtener-el-número-de-viajes-correspondientes-a-cada-aeropuerto-de-origen" class="section level4">
<h4>–¿Cómo podemos obtener el número de viajes correspondientes a cada
aeropuerto de origen?</h4>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[, .(.N), by <span class="ot">=</span> .(origin)]</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>ans</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="co">#    origin     N</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="co">#    &lt;char&gt; &lt;int&gt;</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="co"># 1:    JFK 81483</span></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="co"># 2:    LGA 84433</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="co"># 3:    EWR 87400</span></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="do">## or equivalently using a character vector in &#39;by&#39;</span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a><span class="co"># ans &lt;- flights[, .(.N), by = &quot;origin&quot;]</span></span></code></pre></div>
<p>=====* Sabemos que <code>.N</code> <a href="#special-N">es una
variable especial</a> que contiene la cantidad de filas en el grupo
actual. Al agrupar por <code>origen</code> se obtiene la cantidad de
filas, <code>.N</code>, para cada grupo.=====</p>
<p>=====* Al ejecutar <code>head(flights)</code>, puede ver que los
aeropuertos de origen aparecen en el orden <em>“JFK”</em>,
<em>“LGA”</em> y <em>“EWR”</em>. El orden original de agrupación de las
variables se conserva en el resultado. ¡Es importante tener esto en
cuenta!_=====</p>
<p>=====* Dado que no proporcionamos un nombre para la columna devuelta
en <code>j</code>, se la denominó <code>N</code> automáticamente al
reconocer el símbolo especial <code>.N</code>.=====</p>
<p>=====* <code>by</code> también acepta un vector de caracteres de
nombres de columnas. Esto es particularmente útil para la codificación
programática, por ejemplo, para diseñar una función con las columnas de
agrupación (en forma de un vector de <code>carácter</code>) como
argumento de función.=====</p>
<p>=====* Cuando solo hay una columna o expresión a la que hacer
referencia en <code>j</code> y <code>by</code>, podemos omitir la
notación <code>.()</code>. Esto es puramente por conveniencia. En su
lugar, podríamos hacer lo siguiente:=====</p>
<pre><code>``` r
ans &lt;- flights[, .N, by = origin]
ans
#    origin     N
#    &lt;char&gt; &lt;int&gt;
# 1:    JFK 81483
# 2:    LGA 84433
# 3:    EWR 87400
```

We&#39;ll use this convenient form wherever applicable hereafter.</code></pre>
</div>
<div id="origin-.N" class="section level4">
<h4>– ¿Cómo podemos calcular el número de viajes para cada aeropuerto de
origen para el código de aerolínea <code>&quot;AA&quot;</code>?</h4>
<p>El código único de aerolínea <code>&quot;AA&quot;</code> corresponde a
<em>American Airlines Inc.</em></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[carrier <span class="sc">==</span> <span class="st">&quot;AA&quot;</span>, .N, by <span class="ot">=</span> origin]</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>ans</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="co">#    origin     N</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="co">#    &lt;char&gt; &lt;int&gt;</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="co"># 1:    JFK 11923</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="co"># 2:    LGA 11730</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="co"># 3:    EWR  2649</span></span></code></pre></div>
<p>=====* Primero obtenemos los índices de fila para la expresión
<code>carrier == &quot;AA&quot;</code> de <code>i</code>.=====</p>
<p>=====* Al utilizar esos <em>índices de fila</em>, obtenemos la
cantidad de filas agrupadas por <code>origen</code>. Una vez más, aquí
no se materializan columnas, ya que la <code>j-expression</code> no
requiere que se creen subconjuntos de ninguna columna y, por lo tanto,
es rápida y eficiente en el uso de la memoria.=====</p>
</div>
<div id="origin-dest-.N" class="section level4">
<h4>– ¿Cómo podemos obtener el número total de viajes para cada par
<code>origen, destino</code> para el código de transportista
<code>&quot;AA&quot;</code>?</h4>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[carrier <span class="sc">==</span> <span class="st">&quot;AA&quot;</span>, .N, by <span class="ot">=</span> .(origin, dest)]</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="co">#    origin   dest     N</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="co">#    &lt;char&gt; &lt;char&gt; &lt;int&gt;</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a><span class="co"># 1:    JFK    LAX  3387</span></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a><span class="co"># 2:    LGA    PBI   245</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a><span class="co"># 3:    EWR    LAX    62</span></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a><span class="co"># 4:    JFK    MIA  1876</span></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a><span class="co"># 5:    JFK    SEA   298</span></span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a><span class="co"># 6:    EWR    MIA   848</span></span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a><span class="do">## or equivalently using a character vector in &#39;by&#39;</span></span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a><span class="co"># ans &lt;- flights[carrier == &quot;AA&quot;, .N, by = c(&quot;origin&quot;, &quot;dest&quot;)]</span></span></code></pre></div>
<p>=====* <code>by</code> acepta múltiples columnas. Simplemente
proporcionamos todas las columnas por las que se agrupará. Observe el
uso de <code>.()</code> nuevamente en <code>by</code>; nuevamente, esto
es solo una forma abreviada de <code>list()</code>, y
<code>list()</code> también se puede usar aquí. Nuevamente, nos
quedaremos con <code>.()</code> en esta viñeta.=====</p>
</div>
<div id="origin-dest-month" class="section level4">
<h4>– ¿Cómo podemos obtener el retraso promedio de llegada y salida para
cada par <code>orig,dest</code> para cada mes para el código de operador
<code>&quot;AA&quot;</code>?</h4>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[carrier <span class="sc">==</span> <span class="st">&quot;AA&quot;</span>,</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>        .(<span class="fu">mean</span>(arr_delay), <span class="fu">mean</span>(dep_delay)),</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>        by <span class="ot">=</span> .(origin, dest, month)]</span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>ans</span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a><span class="co">#      origin   dest month         V1         V2</span></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a><span class="co">#      &lt;char&gt; &lt;char&gt; &lt;int&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a><span class="co">#   1:    JFK    LAX     1   6.590361 14.2289157</span></span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a><span class="co">#   2:    LGA    PBI     1  -7.758621  0.3103448</span></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a><span class="co">#   3:    EWR    LAX     1   1.366667  7.5000000</span></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a><span class="co">#   4:    JFK    MIA     1  15.720670 18.7430168</span></span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a><span class="co">#   5:    JFK    SEA     1  14.357143 30.7500000</span></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a><span class="co">#  ---                                          </span></span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a><span class="co"># 196:    LGA    MIA    10  -6.251799 -1.4208633</span></span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a><span class="co"># 197:    JFK    MIA    10  -1.880184  6.6774194</span></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a><span class="co"># 198:    EWR    PHX    10  -3.032258 -4.2903226</span></span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a><span class="co"># 199:    JFK    MCO    10 -10.048387 -1.6129032</span></span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a><span class="co"># 200:    JFK    DCA    10  16.483871 15.5161290</span></span></code></pre></div>
<p>=====* Dado que no proporcionamos nombres de columnas para las
expresiones en <code>j</code>, se generaron automáticamente como
<code>V1</code> y <code>V2</code>.=====</p>
<p>=====* Una vez más, tenga en cuenta que el orden de entrada de las
columnas de agrupación se conserva en el resultado.=====</p>
<p>¿Y ahora qué pasa si queremos ordenar el resultado por las columnas
de agrupación «origen», «destino» y «mes»?</p>
</div>
</div>
<div id="b-ordenado-por-keyby" class="section level3">
<h3>b) Ordenado <code>por</code>: <code>keyby</code></h3>
<p>El hecho de que <code>data.table</code> conserve el orden original de
los grupos es intencional y está diseñado de esa manera. Hay casos en
los que es esencial conservar el orden original, pero en ocasiones nos
gustaría ordenar automáticamente por variables en nuestra
agrupación.</p>
<div id="entonces-cómo-podemos-ordenar-directamente-por-todas-las-variables-de-agrupación" class="section level4">
<h4>–Entonces, ¿cómo podemos ordenar directamente por todas las
variables de agrupación?</h4>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[carrier <span class="sc">==</span> <span class="st">&quot;AA&quot;</span>,</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>        .(<span class="fu">mean</span>(arr_delay), <span class="fu">mean</span>(dep_delay)),</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a>        keyby <span class="ot">=</span> .(origin, dest, month)]</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>ans</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a><span class="co"># Key: &lt;origin, dest, month&gt;</span></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a><span class="co">#      origin   dest month         V1         V2</span></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a><span class="co">#      &lt;char&gt; &lt;char&gt; &lt;int&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a><span class="co">#   1:    EWR    DFW     1   6.427673 10.0125786</span></span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a><span class="co">#   2:    EWR    DFW     2  10.536765 11.3455882</span></span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a><span class="co">#   3:    EWR    DFW     3  12.865031  8.0797546</span></span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a><span class="co">#   4:    EWR    DFW     4  17.792683 12.9207317</span></span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a><span class="co">#   5:    EWR    DFW     5  18.487805 18.6829268</span></span>
<span id="cb32-13"><a href="#cb32-13" tabindex="-1"></a><span class="co">#  ---                                          </span></span>
<span id="cb32-14"><a href="#cb32-14" tabindex="-1"></a><span class="co"># 196:    LGA    PBI     1  -7.758621  0.3103448</span></span>
<span id="cb32-15"><a href="#cb32-15" tabindex="-1"></a><span class="co"># 197:    LGA    PBI     2  -7.865385  2.4038462</span></span>
<span id="cb32-16"><a href="#cb32-16" tabindex="-1"></a><span class="co"># 198:    LGA    PBI     3  -5.754098  3.0327869</span></span>
<span id="cb32-17"><a href="#cb32-17" tabindex="-1"></a><span class="co"># 199:    LGA    PBI     4 -13.966667 -4.7333333</span></span>
<span id="cb32-18"><a href="#cb32-18" tabindex="-1"></a><span class="co"># 200:    LGA    PBI     5 -10.357143 -6.8571429</span></span></code></pre></div>
<p>=====* Todo lo que hicimos fue cambiar <code>by</code> por
<code>keyby</code>. Esto ordena automáticamente el resultado por las
variables de agrupación en orden creciente. De hecho, debido a que la
implementación interna de <code>by</code> requiere primero una
clasificación antes de recuperar el orden de la tabla original,
<code>keyby</code> es típicamente más rápido que <code>by</code> porque
no requiere este segundo paso.=====</p>
<p><strong>Claves:</strong> En realidad, <code>keyby</code> hace un poco
más que <em>simplemente ordenar</em>. También <em>establece una
clave</em> después de ordenar, estableciendo un <code>atributo</code>
llamado <code>sorted</code>.</p>
<p>Aprenderemos más sobre <code>claves</code> en la viñeta
<em>Subconjunto basado en claves y búsqueda binaria rápida</em>; por
ahora, todo lo que tiene que saber es que puede usar <code>keyby</code>
para ordenar automáticamente el resultado por las columnas especificadas
en <code>by</code>.</p>
</div>
</div>
<div id="c-encadenamiento" class="section level3">
<h3>c) Encadenamiento</h3>
<p>Reconsideremos la tarea de <a href="#origin-dest-.N">obtener el
número total de viajes para cada par <code>origen, destino</code> para
el transportista <em>“AA”</em></a>.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[carrier <span class="sc">==</span> <span class="st">&quot;AA&quot;</span>, .N, by <span class="ot">=</span> .(origin, dest)]</span></code></pre></div>
<div id="cómo-podemos-ordenar-ans-utilizando-las-columnas-origin-en-orden-ascendente-y-dest-en-orden-descendente" class="section level4">
<h4>– ¿Cómo podemos ordenar <code>ans</code> utilizando las columnas
<code>origin</code> en orden ascendente y <code>dest</code> en orden
descendente?</h4>
<p>Podemos almacenar el resultado intermedio en una variable y luego
usar <code>order(origin, -dest)</code> en esa variable. Parece bastante
sencillo.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> ans[<span class="fu">order</span>(origin, <span class="sc">-</span>dest)]</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="co">#    origin   dest     N</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a><span class="co">#    &lt;char&gt; &lt;char&gt; &lt;int&gt;</span></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a><span class="co"># 1:    EWR    PHX   121</span></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a><span class="co"># 2:    EWR    MIA   848</span></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a><span class="co"># 3:    EWR    LAX    62</span></span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a><span class="co"># 4:    EWR    DFW  1618</span></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a><span class="co"># 5:    JFK    STT   229</span></span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a><span class="co"># 6:    JFK    SJU   690</span></span></code></pre></div>
<p>=====* Recordemos que podemos usar <code>-</code> en una columna
<code>character</code> en <code>order()</code> dentro del marco de un
<code>data.table</code>. Esto es posible gracias a la optimización de
consultas internas de <code>data.table</code>.=====</p>
<p>=====* Recuerde también que <code>order(...)</code> con el marco de
una <code>data.table</code> se <em>optimiza automáticamente</em> para
usar el orden de radio rápido interno de <code>data.table</code>
<code>forder()</code> para mayor velocidad. =====</p>
<p>Pero esto requiere tener que asignar el resultado intermedio y luego
sobrescribirlo. Podemos hacer algo mejor y evitar por completo esta
asignación intermedia a una variable temporal <em>encadenando</em>
expresiones.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[carrier <span class="sc">==</span> <span class="st">&quot;AA&quot;</span>, .N, by <span class="ot">=</span> .(origin, dest)][<span class="fu">order</span>(origin, <span class="sc">-</span>dest)]</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="fu">head</span>(ans, <span class="dv">10</span>)</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="co">#     origin   dest     N</span></span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a><span class="co">#     &lt;char&gt; &lt;char&gt; &lt;int&gt;</span></span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a><span class="co">#  1:    EWR    PHX   121</span></span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a><span class="co">#  2:    EWR    MIA   848</span></span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a><span class="co">#  3:    EWR    LAX    62</span></span>
<span id="cb35-8"><a href="#cb35-8" tabindex="-1"></a><span class="co">#  4:    EWR    DFW  1618</span></span>
<span id="cb35-9"><a href="#cb35-9" tabindex="-1"></a><span class="co">#  5:    JFK    STT   229</span></span>
<span id="cb35-10"><a href="#cb35-10" tabindex="-1"></a><span class="co">#  6:    JFK    SJU   690</span></span>
<span id="cb35-11"><a href="#cb35-11" tabindex="-1"></a><span class="co">#  7:    JFK    SFO  1312</span></span>
<span id="cb35-12"><a href="#cb35-12" tabindex="-1"></a><span class="co">#  8:    JFK    SEA   298</span></span>
<span id="cb35-13"><a href="#cb35-13" tabindex="-1"></a><span class="co">#  9:    JFK    SAN   299</span></span>
<span id="cb35-14"><a href="#cb35-14" tabindex="-1"></a><span class="co"># 10:    JFK    ORD   432</span></span></code></pre></div>
<p>=====* Podemos unir expresiones una tras otra, <em>formando una
cadena</em> de operaciones, es decir,
<code>DT[ ... ][ ... ][ ... ]</code>.=====</p>
<ul>
<li><p>O también podemos encadenarlas verticalmente:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>DT[ ...</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>   ][ ...</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>     ][ ...</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a>       ]</span></code></pre></div></li>
</ul>
</div>
</div>
<div id="d-expresiones-en-by" class="section level3">
<h3>d) Expresiones en <code>by</code></h3>
<div id="puede-by-también-aceptar-expresiones-o-sólo-toma-columnas" class="section level4">
<h4>– ¿Puede <code>by</code> también aceptar <em>expresiones</em> o sólo
toma columnas?</h4>
<p>Sí, lo hace. Por ejemplo, si queremos saber cuántos vuelos empezaron
con retraso pero llegaron antes (o a tiempo), empezaron y llegaron con
retraso, etc.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[, .N, .(dep_delay<span class="sc">&gt;</span><span class="dv">0</span>, arr_delay<span class="sc">&gt;</span><span class="dv">0</span>)]</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>ans</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="co">#    dep_delay arr_delay      N</span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="co">#       &lt;lgcl&gt;    &lt;lgcl&gt;  &lt;int&gt;</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="co"># 1:      TRUE      TRUE  72836</span></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="co"># 2:     FALSE      TRUE  34583</span></span>
<span id="cb37-7"><a href="#cb37-7" tabindex="-1"></a><span class="co"># 3:     FALSE     FALSE 119304</span></span>
<span id="cb37-8"><a href="#cb37-8" tabindex="-1"></a><span class="co"># 4:      TRUE     FALSE  26593</span></span></code></pre></div>
<p>=====* La última fila corresponde a
<code>dep_delay &gt; 0 = TRUE</code> y
<code>arr_delay &gt; 0 = FALSE</code>. Podemos ver que 26593 los vuelos
partieron tarde pero llegaron temprano (o a tiempo).=====</p>
<p>=====* Tenga en cuenta que no proporcionamos ningún nombre a
<code>by-expression</code>. Por lo tanto, los nombres se han asignado
automáticamente en el resultado. Al igual que con <code>j</code>, puede
nombrar estas expresiones como lo haría para los elementos de cualquier
<code>list</code>, como por ejemplo
<code>DT[, .N, .(dep_delayed = dep_delay&gt;0, arr_delayed = arr_delay&gt;0)]</code>.=====</p>
<p>=====* Puede proporcionar otras columnas junto con expresiones, por
ejemplo: <code>DT[, .N, by = .(a, b&gt;0)]</code>.=====</p>
</div>
</div>
<div id="e-varias-columnas-en-j---.sd" class="section level3">
<h3>e) Varias columnas en <code>j</code> - <code>.SD</code></h3>
<div id="tenemos-que-calcular-mean-para-cada-columna-individualmente" class="section level4">
<h4>– ¿Tenemos que calcular <code>mean()</code> para cada columna
individualmente?</h4>
<p>Por supuesto, no es práctico tener que escribir
<code>mean(myCol)</code> para cada columna una por una. ¿Qué sucedería
si tuviera 100 columnas para calcular el promedio de
<code>mean()</code>?</p>
<p>¿Cómo podemos hacer esto de manera eficiente y concisa? Para
lograrlo, repasemos <a href="#tip-1">este consejo</a>: <em>“Siempre que
la expresión <code>j</code> devuelva una <code>list</code>, cada
elemento de la <code>list</code> se convertirá en una columna en la
<code>tabla de datos</code> resultante”</em>. Si podemos hacer
referencia al <em>subconjunto de datos de cada grupo</em> como una
variable <em>mientras agrupamos</em>, podemos recorrer todas las
columnas de esa variable utilizando la función base
<code>lapply()</code>, que ya nos resulta familiar o que pronto nos
resultará familiar. No hay que aprender nuevos nombres específicos de
<code>data.table</code>.</p>
</div>
<div id="special-SD" class="section level4">
<h4>Símbolo especial <code>.SD</code>:</h4>
<p><code>data.table</code> proporciona un símbolo <em>especial</em>
llamado <code>.SD</code>. Significa <strong>S</strong>subset of
<strong>D</strong>ata. Es en sí mismo una <code>data.table</code> que
contiene los datos para <em>el grupo actual</em> definido usando
<code>by</code>.</p>
<p>Recuerde que una <code>data.table</code> es internamente también una
<code>list</code> con todas sus columnas de igual longitud.</p>
<p>Utilicemos la <a href="#what-is-datatable-1a"><code>data.table</code>
<code>DT</code> de antes</a> para tener una idea de cómo se ve
<code>.SD</code>.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>DT</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a><span class="co">#        ID     a     b     c</span></span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a><span class="co">#    &lt;char&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a><span class="co"># 1:      b     1     7    13</span></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a><span class="co"># 2:      b     2     8    14</span></span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a><span class="co"># 3:      b     3     9    15</span></span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a><span class="co"># 4:      a     4    10    16</span></span>
<span id="cb38-8"><a href="#cb38-8" tabindex="-1"></a><span class="co"># 5:      a     5    11    17</span></span>
<span id="cb38-9"><a href="#cb38-9" tabindex="-1"></a><span class="co"># 6:      c     6    12    18</span></span>
<span id="cb38-10"><a href="#cb38-10" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" tabindex="-1"></a>DT[, <span class="fu">print</span>(.SD), by <span class="ot">=</span> ID]</span>
<span id="cb38-12"><a href="#cb38-12" tabindex="-1"></a><span class="co">#        a     b     c</span></span>
<span id="cb38-13"><a href="#cb38-13" tabindex="-1"></a><span class="co">#    &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb38-14"><a href="#cb38-14" tabindex="-1"></a><span class="co"># 1:     1     7    13</span></span>
<span id="cb38-15"><a href="#cb38-15" tabindex="-1"></a><span class="co"># 2:     2     8    14</span></span>
<span id="cb38-16"><a href="#cb38-16" tabindex="-1"></a><span class="co"># 3:     3     9    15</span></span>
<span id="cb38-17"><a href="#cb38-17" tabindex="-1"></a><span class="co">#        a     b     c</span></span>
<span id="cb38-18"><a href="#cb38-18" tabindex="-1"></a><span class="co">#    &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb38-19"><a href="#cb38-19" tabindex="-1"></a><span class="co"># 1:     4    10    16</span></span>
<span id="cb38-20"><a href="#cb38-20" tabindex="-1"></a><span class="co"># 2:     5    11    17</span></span>
<span id="cb38-21"><a href="#cb38-21" tabindex="-1"></a><span class="co">#        a     b     c</span></span>
<span id="cb38-22"><a href="#cb38-22" tabindex="-1"></a><span class="co">#    &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb38-23"><a href="#cb38-23" tabindex="-1"></a><span class="co"># 1:     6    12    18</span></span>
<span id="cb38-24"><a href="#cb38-24" tabindex="-1"></a><span class="co"># Empty data.table (0 rows and 1 cols): ID</span></span></code></pre></div>
<p>=====* <code>.SD</code> contiene todas las columnas <em>excepto las
columnas de agrupación</em> de forma predeterminada.=====</p>
<p>=====* También se genera conservando el orden original: datos
correspondientes a <code>ID = &quot;b&quot;</code>, luego <code>ID = &quot;a&quot;</code>, y
luego <code>ID = &quot;c&quot;</code>.=====</p>
<p>Para calcular en (múltiples) columnas, podemos simplemente usar la
función base R <code>lapply()</code>.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>DT[, <span class="fu">lapply</span>(.SD, mean), by <span class="ot">=</span> ID]</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a><span class="co">#        ID     a     b     c</span></span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a><span class="co">#    &lt;char&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="co"># 1:      b   2.0   8.0  14.0</span></span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a><span class="co"># 2:      a   4.5  10.5  16.5</span></span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a><span class="co"># 3:      c   6.0  12.0  18.0</span></span></code></pre></div>
<p>=====* <code>.SD</code> contiene las filas correspondientes a las
columnas <code>a</code>, <code>b</code> y <code>c</code> de ese grupo.
Calculamos la <code>mean()</code> de cada una de estas columnas
utilizando la función base <code>lapply()</code>, que ya
conocemos.=====</p>
<p>=====* Cada grupo devuelve una lista de tres elementos que contienen
el valor medio que se convertirán en las columnas de la tabla
<code>data.table</code> resultante.=====</p>
<p>=====* Dado que <code>lapply()</code> devuelve una <code>list</code>,
no es necesario envolverla con un <code>.()</code> adicional (si es
necesario, consulte <a href="#tip-1">este consejo</a>).=====</p>
<p>Ya casi estamos listos. Queda un pequeño detalle por resolver. En
nuestra tabla de datos <code>flights</code>, solo queríamos calcular
<code>mean()</code> de las dos columnas <code>arr_delay</code> y
<code>dep_delay</code>. Pero <code>.SD</code> contendría todas las
columnas excepto las variables de agrupamiento de forma
predeterminada.</p>
</div>
<div id="cómo-podemos-especificar-sólo-las-columnas-en-las-que-nos-gustaría-calcular-la-mean" class="section level4">
<h4>– ¿Cómo podemos especificar sólo las columnas en las que nos
gustaría calcular la <code>mean()</code>?</h4>
</div>
<div id="sdcols" class="section level4">
<h4>.SDcols</h4>
<p>Utilizando el argumento <code>.SDcols</code>. Acepta nombres de
columnas o índices de columnas. Por ejemplo,
<code>.SDcols = c(&quot;arr_delay&quot;, &quot;dep_delay&quot;)</code> garantiza que
<code>.SD</code> contenga solo estas dos columnas para cada grupo.</p>
<p>De manera similar a <a href="#refer_j">parte g)</a>, también puede
especificar las columnas que desea eliminar en lugar de las columnas que
desea conservar utilizando <code>-</code> o <code>!</code>. Además,
puede seleccionar columnas consecutivas como <code>colA:colB</code> y
deseleccionarlas como <code>!(colA:colB)</code> o
<code>-(colA:colB)</code>.</p>
<p>Ahora intentemos usar <code>.SD</code> junto con <code>.SDcols</code>
para obtener la <code>mean()</code> de las columnas
<code>arr_delay</code> y <code>dep_delay</code> agrupadas por
<code>origen</code>, <code>dest</code> y <code>mes</code>.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>flights[carrier <span class="sc">==</span> <span class="st">&quot;AA&quot;</span>,                       <span class="do">## Only on trips with carrier &quot;AA&quot;</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>        <span class="fu">lapply</span>(.SD, mean),                     <span class="do">## compute the mean</span></span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a>        by <span class="ot">=</span> .(origin, dest, month),           <span class="do">## for every &#39;origin,dest,month&#39;</span></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>        .SDcols <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;arr_delay&quot;</span>, <span class="st">&quot;dep_delay&quot;</span>)] <span class="do">## for just those specified in .SDcols</span></span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a><span class="co">#      origin   dest month  arr_delay  dep_delay</span></span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a><span class="co">#      &lt;char&gt; &lt;char&gt; &lt;int&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a><span class="co">#   1:    JFK    LAX     1   6.590361 14.2289157</span></span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a><span class="co">#   2:    LGA    PBI     1  -7.758621  0.3103448</span></span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a><span class="co">#   3:    EWR    LAX     1   1.366667  7.5000000</span></span>
<span id="cb40-10"><a href="#cb40-10" tabindex="-1"></a><span class="co">#   4:    JFK    MIA     1  15.720670 18.7430168</span></span>
<span id="cb40-11"><a href="#cb40-11" tabindex="-1"></a><span class="co">#   5:    JFK    SEA     1  14.357143 30.7500000</span></span>
<span id="cb40-12"><a href="#cb40-12" tabindex="-1"></a><span class="co">#  ---                                          </span></span>
<span id="cb40-13"><a href="#cb40-13" tabindex="-1"></a><span class="co"># 196:    LGA    MIA    10  -6.251799 -1.4208633</span></span>
<span id="cb40-14"><a href="#cb40-14" tabindex="-1"></a><span class="co"># 197:    JFK    MIA    10  -1.880184  6.6774194</span></span>
<span id="cb40-15"><a href="#cb40-15" tabindex="-1"></a><span class="co"># 198:    EWR    PHX    10  -3.032258 -4.2903226</span></span>
<span id="cb40-16"><a href="#cb40-16" tabindex="-1"></a><span class="co"># 199:    JFK    MCO    10 -10.048387 -1.6129032</span></span>
<span id="cb40-17"><a href="#cb40-17" tabindex="-1"></a><span class="co"># 200:    JFK    DCA    10  16.483871 15.5161290</span></span></code></pre></div>
</div>
</div>
<div id="f-subconjunto-.sd-para-cada-grupo" class="section level3">
<h3>f) Subconjunto <code>.SD</code> para cada grupo:</h3>
<div id="cómo-podemos-devolver-las-dos-primeras-filas-de-cada-mes" class="section level4">
<h4>– ¿Cómo podemos devolver las dos primeras filas de cada “mes”?</h4>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>ans <span class="ot">&lt;-</span> flights[, <span class="fu">head</span>(.SD, <span class="dv">2</span>), by <span class="ot">=</span> month]</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a><span class="fu">head</span>(ans)</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a><span class="co">#    month  year   day dep_delay arr_delay carrier origin   dest air_time distance  hour</span></span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a><span class="co">#    &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;     &lt;int&gt;  &lt;char&gt; &lt;char&gt; &lt;char&gt;    &lt;int&gt;    &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a><span class="co"># 1:     1  2014     1        14        13      AA    JFK    LAX      359     2475     9</span></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a><span class="co"># 2:     1  2014     1        -3        13      AA    JFK    LAX      363     2475    11</span></span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a><span class="co"># 3:     2  2014     1        -1         1      AA    JFK    LAX      358     2475     8</span></span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a><span class="co"># 4:     2  2014     1        -5         3      AA    JFK    LAX      358     2475    11</span></span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a><span class="co"># 5:     3  2014     1       -11        36      AA    JFK    LAX      375     2475     8</span></span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a><span class="co"># 6:     3  2014     1        -3        14      AA    JFK    LAX      368     2475    11</span></span></code></pre></div>
<p>=====* <code>.SD</code> es una <code>data.table</code> que contiene
todas las filas de <em>ese grupo</em>. Simplemente creamos un
subconjunto de las dos primeras filas como ya hemos visto <a href="#subset-rows-integer">aquí</a>.=====</p>
<p>=====* Para cada grupo, <code>head(.SD, 2)</code> devuelve las
primeras dos filas como una <code>data.table</code>, que también es una
<code>list</code>, por lo que no tenemos que envolverla con
<code>.()</code>.=====</p>
</div>
</div>
<div id="g-por-qué-mantener-j-tan-flexible" class="section level3">
<h3>g) ¿Por qué mantener <code>j</code> tan flexible?</h3>
<p>Para que tengamos una sintaxis consistente y sigamos usando funciones
base ya existentes (y conocidas) en lugar de aprender nuevas funciones,
para ilustrarlo, usemos la tabla <code>data.table</code> <code>DT</code>
que creamos al principio en la sección <a href="#what-is-datatable-1a">¿Qué es una tabla data.table?</a>.</p>
<div id="cómo-podemos-concatenar-las-columnas-a-y-b-para-cada-grupo-en-id" class="section level4">
<h4>– ¿Cómo podemos concatenar las columnas <code>a</code> y
<code>b</code> para cada grupo en <code>ID</code>?</h4>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a>DT[, .(<span class="at">val =</span> <span class="fu">c</span>(a,b)), by <span class="ot">=</span> ID]</span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="co">#         ID   val</span></span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a><span class="co">#     &lt;char&gt; &lt;int&gt;</span></span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a><span class="co">#  1:      b     1</span></span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a><span class="co">#  2:      b     2</span></span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a><span class="co">#  3:      b     3</span></span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a><span class="co">#  4:      b     7</span></span>
<span id="cb42-8"><a href="#cb42-8" tabindex="-1"></a><span class="co">#  5:      b     8</span></span>
<span id="cb42-9"><a href="#cb42-9" tabindex="-1"></a><span class="co">#  6:      b     9</span></span>
<span id="cb42-10"><a href="#cb42-10" tabindex="-1"></a><span class="co">#  7:      a     4</span></span>
<span id="cb42-11"><a href="#cb42-11" tabindex="-1"></a><span class="co">#  8:      a     5</span></span>
<span id="cb42-12"><a href="#cb42-12" tabindex="-1"></a><span class="co">#  9:      a    10</span></span>
<span id="cb42-13"><a href="#cb42-13" tabindex="-1"></a><span class="co"># 10:      a    11</span></span>
<span id="cb42-14"><a href="#cb42-14" tabindex="-1"></a><span class="co"># 11:      c     6</span></span>
<span id="cb42-15"><a href="#cb42-15" tabindex="-1"></a><span class="co"># 12:      c    12</span></span></code></pre></div>
<p>=====* Eso es todo. No se requiere ninguna sintaxis especial. Todo lo
que necesitamos saber es la función base <code>c()</code> que concatena
vectores y <a href="#tip-1">el consejo de antes</a>.=====</p>
</div>
<div id="qué-pasa-si-queremos-tener-todos-los-valores-de-las-columnas-a-y-b-concatenados-pero-devueltos-como-una-columna-de-lista" class="section level4">
<h4>– ¿Qué pasa si queremos tener todos los valores de las columnas
<code>a</code> y <code>b</code> concatenados, pero devueltos como una
columna de lista?</h4>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>DT[, .(<span class="at">val =</span> <span class="fu">list</span>(<span class="fu">c</span>(a,b))), by <span class="ot">=</span> ID]</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="co">#        ID         val</span></span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a><span class="co">#    &lt;char&gt;      &lt;list&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="co"># 1:      b 1,2,3,7,8,9</span></span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a><span class="co"># 2:      a  4, 5,10,11</span></span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a><span class="co"># 3:      c        6,12</span></span></code></pre></div>
<p>=====* Aquí, primero concatenamos los valores con <code>c(a,b)</code>
para cada grupo y los envolvemos con <code>list()</code>. Por lo tanto,
para cada grupo, devolvemos una lista de todos los valores
concatenados.=====</p>
<p>=====* Tenga en cuenta que esas comas son solo para visualización.
Una columna de lista puede contener cualquier objeto en cada celda y, en
este ejemplo, cada celda es en sí misma un vector y algunas celdas
contienen vectores más largos que otras.=====</p>
<p>Una vez que comiences a internalizar el uso de <code>j</code>, se
dará cuenta de lo poderosa que puede ser la sintaxis. Una forma muy útil
de entenderla es jugando con ella, con la ayuda de
<code>print()</code>.</p>
<p>Por ejemplo:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="do">## look at the difference between</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a>DT[, <span class="fu">print</span>(<span class="fu">c</span>(a,b)), by <span class="ot">=</span> ID] <span class="co"># (1)</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a><span class="co"># [1] 1 2 3 7 8 9</span></span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a><span class="co"># [1]  4  5 10 11</span></span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a><span class="co"># [1]  6 12</span></span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a><span class="co"># Empty data.table (0 rows and 1 cols): ID</span></span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a><span class="do">## and</span></span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a>DT[, <span class="fu">print</span>(<span class="fu">list</span>(<span class="fu">c</span>(a,b))), by <span class="ot">=</span> ID] <span class="co"># (2)</span></span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a><span class="co"># [[1]]</span></span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a><span class="co"># [1] 1 2 3 7 8 9</span></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb44-13"><a href="#cb44-13" tabindex="-1"></a><span class="co"># [[1]]</span></span>
<span id="cb44-14"><a href="#cb44-14" tabindex="-1"></a><span class="co"># [1]  4  5 10 11</span></span>
<span id="cb44-15"><a href="#cb44-15" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb44-16"><a href="#cb44-16" tabindex="-1"></a><span class="co"># [[1]]</span></span>
<span id="cb44-17"><a href="#cb44-17" tabindex="-1"></a><span class="co"># [1]  6 12</span></span>
<span id="cb44-18"><a href="#cb44-18" tabindex="-1"></a><span class="co"># Empty data.table (0 rows and 1 cols): ID</span></span></code></pre></div>
<p>En (1), para cada grupo, se devuelve un vector, con longitud = 6,4,2
aquí. Sin embargo, (2) devuelve una lista de longitud 1 para cada grupo,
con su primer elemento que contiene vectores de longitud 6,4,2. Por lo
tanto, (1) da como resultado una longitud de <code>6+4+2 = 12</code>,
mientras que (2) devuelve <code>1+1+1=3</code>.</p>
</div>
</div>
</div>
<div id="resumen" class="section level2">
<h2>Resumen</h2>
<p>La forma general de la sintaxis de <code>data.table</code> es:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>DT[i, j, by]</span></code></pre></div>
<p>Hemos visto hasta ahora que,</p>
<div id="usando-i" class="section level4">
<h4>Usando <code>i</code>:</h4>
<p>=====* Podemos crear subconjuntos de filas de manera similar a un
<code>data.frame</code>, excepto que no es necesario usar
<code>DT$$$</code> repetidamente, ya que las columnas dentro del marco
de un <code>data.table</code> se ven como si fueran
<em>variables</em>.=====</p>
<p>=====* También podemos ordenar una <code>data.table</code> usando
<code>order()</code>, que internamente usa el orden rápido de data.table
para un mejor rendimiento.=====</p>
<p>Podemos hacer mucho más en <code>i</code> introduciendo claves en
<code>data.table</code>, lo que permite crear subconjuntos y uniones con
una velocidad increíble. Veremos esto en la viñeta <em>“Claves y
subconjuntos basados ​​en búsqueda binaria rápida”</em> y <em>“Uniones y
uniones continuas”</em>.</p>
</div>
<div id="usando-j" class="section level4">
<h4>Usando <code>j</code>:</h4>
<p>=====1. Seleccione columnas con el método <code>data.table</code>:
<code>DT[, .(colA, colB)]</code>.=====</p>
<p>=====2. Seleccione columnas con el método <code>data.frame</code>:
<code>DT[, c(&quot;colA&quot;, &quot;colB&quot;)]</code>.=====</p>
<ol start="3" style="list-style-type: decimal">
<li>Calcular en las columnas:
<code>DT[, .(sum(colA), mean(colB))]</code>.</li>
</ol>
<p>=====4. Proporcione nombres si es necesario:
<code>DT[, .(sA =sum(colA), mB = mean(colB))]</code>.=====</p>
<ol start="5" style="list-style-type: decimal">
<li>Combine con <code>i</code>:
<code>DT[colA &gt; valor, suma(colB)]</code>.</li>
</ol>
</div>
<div id="usando-por" class="section level4">
<h4>Usando <code>por</code>:</h4>
<p>=====* Al usar <code>by</code>, podemos agrupar por columnas
especificando una <em>lista de columnas</em> o un <em>vector de
caracteres de nombres de columnas</em> o incluso <em>expresiones</em>.
La flexibilidad de <code>j</code>, combinada con <code>by</code> e
<code>i</code>, crea una sintaxis muy poderosa.=====</p>
<ul>
<li><code>by</code> puede manejar múltiples columnas y también
<em>expresiones</em>.</li>
</ul>
<p>=====* Podemos agrupar columnas mediante clave para ordenar
automáticamente el resultado agrupado.=====</p>
<p>=====* Podemos usar <code>.SD</code> y <code>.SDcols</code> en
<code>j</code> para operar en múltiples columnas usando funciones base
que ya conocemos. A continuación se muestran algunos ejemplos:=====</p>
<p>===== 1. <code>DT[, lapply(.SD, fun), by = ..., .SDcols = ...]</code>
- aplica <code>fun</code> a todas las columnas especificadas en
<code>.SDcols</code> mientras agrupa por las columnas especificadas en
<code>by</code>.=====</p>
<p>===== 2. <code>DT[, head(.SD, 2), by = ...]</code> - devuelve las dos
primeras filas de cada grupo.=====</p>
<p>===== 3. <code>DT[col &gt; val, head(.SD, 1), by = ...]</code> -
combina <code>i</code> junto con <code>j</code> y
<code>by</code>.=====</p>
</div>
<div id="y-recuerde-el-consejo" class="section level4">
<h4>Y recuerde el consejo:</h4>
<p>Siempre que <code>j</code> devuelva una <code>list</code>, cada
elemento de la lista se convertirá en una columna en la
<code>data.table</code> resultante.</p>
<p>Veremos cómo <em>agregar/actualizar/eliminar</em> columnas <em>por
referencia</em> y cómo combinarlas con <code>i</code> y <code>by</code>
en la próxima viñeta.</p>
<hr />
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
